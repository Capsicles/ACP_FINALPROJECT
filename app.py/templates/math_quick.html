<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Math Quick Solve</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .card {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    h1 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 32px;
    }
    #problem h2 {
      color: #333;
      font-size: 36px;
      margin: 20px 0;
    }
    #problem p {
      color: #667eea;
      font-weight: bold;
      font-size: 18px;
    }
    input {
      padding: 15px;
      border-radius: 12px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      width: 100%;
      font-size: 18px;
      margin-top: 15px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    button {
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-right: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    #feedback {
      font-size: 18px;
      font-weight: bold;
      margin-top: 15px;
    }
    .back-home-btn {
      color: white;
      text-decoration: none;
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: inline-block;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .back-home-btn:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    /* Global floating home button */
    .home-fab {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 24px);
      right: 22px;
      z-index: 1000;
      border-radius: 999px;
      padding: 12px 20px;
    }
    /* Results styles */
    .score-container { text-align:center; padding:14px 12px; background:#fff; border-radius:14px; margin:16px auto; box-shadow:0 1px 6px rgba(102,126,234,0.13); max-width:360px; display:flex; flex-direction:column; align-items:center; gap:6px; }
    .score-title { font-size:1.12em; color:#667eea; margin:2px 0 2px; font-weight:600; }
    .score-display { font-size:2.1em; font-weight:700; color:#4e54c8; margin:0; padding:6px 12px; background:#f5f8ff; border-radius:10px; border:1px solid #e2e8f0; display:inline-block; line-height:1; }
    .score-fraction { font-size:.92em; color:#667eea; margin:0; font-weight:600; }
    .score-percentage { font-size:.92em; color:#667eea; font-weight:700; margin:0; }
    .score-message { padding:6px 10px; background:#f5f8ff; color:#667eea; border-radius:8px; margin:4px 0 2px; font-weight:600; font-size:12px; border:1px solid #e2e8f0; }
    .score-message.error { background:#fff5f5; color:#ff4757; border-color:#fed7d7; }
    .leaderboard-link { display:inline-block; margin-top:10px; padding:8px 18px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; text-decoration:none; border-radius:10px; font-weight:bold; font-size:13px; transition:all .3s; box-shadow:0 4px 15px rgba(102,126,234,.3); }
    .leaderboard-link:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,.4); background:linear-gradient(135deg,#764ba2 0%, #667eea 100%); }
  </style>
</head>
<body>
  <div class="card">
    <h1>Math Quick Solve</h1>
    <div id="problem"></div>
    <div id="answerRow" style="margin-top:8px"><input id="answer" placeholder="Answer" aria-label="Answer"></div>
    <div style="margin-top:15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <a href="/home" class="back-home-btn home-fab" onclick="try{stopAllAudio&&stopAllAudio();}catch(e){}">‚Üê Back to Home</a>
    </div>
    <div id="feedback" style="margin-top:12px"></div>
  </div>

  <script>
    let current;
    let score = 0;
    let totalProblems = 0; // equals quizLength at end
    let correctCount = 0;  // computed at the end
    let questionActive = false;
    let autoSubmitTimer = null;
    const quizLength = 10;
    let currentIndex = 0;
    const problems = [];
    const userAnswers = [];
    
    function stopAllAudio(){ if(window.speechSynthesis){ try{ speechSynthesis.cancel(); }catch(e){} } }
    
    async function saveScore(finalScore) {
      try {
        const response = await fetch('/api/add-score', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            score: finalScore,
            game: 'Math Quick Solve'
          })
        });
        const data = await response.json();
        if (data.success) {
          const msg = document.getElementById('scoreMessage');
          if (msg) { msg.innerHTML = '‚úÖ Score saved successfully!'; msg.className='score-message'; }
        }
      } catch (error) {
        console.error('Error saving score:', error);
      }
    }
    
    function newProblem(){
      // End of quiz -> show results once
      if (currentIndex >= quizLength) {
        // compute results
        correctCount = 0;
        for (let i=0;i<problems.length;i++){
          const {a,b,op} = problems[i];
          let correct=0; if(op==='+') correct=a+b; else if(op==='-') correct=a-b; else correct=a*b;
          if (Number(userAnswers[i]) === correct) correctCount++;
        }
        totalProblems = quizLength;
        score = correctCount * 10;
        const pct = Math.round((correctCount/quizLength)*100);
        document.getElementById('problem').innerHTML = `
          <div class="score-container">
            <div class="score-title">Quiz Complete! üéâ</div>
            <div class="score-display">${score}</div>
            <div id="scoreMessage" class="score-message">Saving score...</div>
            <a href="/leaderboard" id="leaderboardLink" class="leaderboard-link">View Leaderboard ‚Üí</a>
          </div>`;
        // hide input row and stop listening
        questionActive = false;
        const ansEl = document.getElementById('answer');
        if (ansEl) { ansEl.value=''; ansEl.setAttribute('disabled','disabled'); try{ ansEl.blur(); }catch(e){} }
        const row = document.getElementById('answerRow');
        if (row) { row.style.display = 'none'; }
        const fb = document.getElementById('feedback');
        if (fb) { fb.style.display = 'none'; }
        if (autoSubmitTimer) { clearTimeout(autoSubmitTimer); autoSubmitTimer = null; }
        // save total score once
        saveScore(score);
        return;
      }

      // Generate next problem silently
      questionActive = true;
      const a=Math.floor(Math.random()*20)+1; 
      const b=Math.floor(Math.random()*20)+1; 
      const op = ['+','-','x'][Math.floor(Math.random()*3)]; 
      current = {a,b,op};
      problems[currentIndex] = current;
      document.getElementById('problem').innerHTML = `<h2> ${a} ${op} ${b} </h2>`; 
      if(window.speechSynthesis){
        stopAllAudio();
        const exprText = document.getElementById('problem').textContent.replace(/\s+/g,'').trim();
        speechSynthesis.speak(new SpeechSynthesisUtterance(exprText));
      }
      const ansEl = document.getElementById('answer');
      ansEl.value='';
      document.getElementById('feedback').innerText='';
      try { ansEl.focus(); ansEl.select(); } catch(e) {}
    }
    
    function check(){
      if(!questionActive) return;
      stopAllAudio();
      const val = document.getElementById('answer').value.trim();
      if(val==='') { return; }
      questionActive = false;
      userAnswers[currentIndex] = val;
      currentIndex++;
      newProblem();
    }
    
    // Add keyboard support - Enter submits only when valid number
    document.getElementById('answer').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const fb = document.getElementById('feedback');
        const v = document.getElementById('answer').value.trim();
        if (v === '') { fb.textContent = 'Enter your answer to continue.'; return; }
        if (v === '-' || !/^-?\d+$/.test(v)) { fb.textContent = 'Please enter a valid number.'; return; }
        fb.textContent = '';
        check();
      }
    });
    // Auto-advance only when input is a complete valid integer (debounced)
    document.getElementById('answer').addEventListener('input', function(e) {
      if (!questionActive) return;
      const fb = document.getElementById('feedback');
      const v = e.target.value.trim();
      if (autoSubmitTimer) clearTimeout(autoSubmitTimer);
      if (v === '') { fb.textContent = 'Enter your answer to continue.'; return; }
      if (v === '-' || !/^-?\d+$/.test(v)) { fb.textContent = 'Please enter a valid number.'; return; }
      fb.textContent = '';
      autoSubmitTimer = setTimeout(() => { if(questionActive) check(); }, 800);
    });
    // Accessibility: announce updates and keep focus in the answer field
    try {
      document.getElementById('problem').setAttribute('aria-live','polite');
      const fb = document.getElementById('feedback');
      fb.setAttribute('role','status');
      fb.setAttribute('aria-live','polite');
    } catch(e) {}
    newProblem();
  </script>
</body>
</html>
